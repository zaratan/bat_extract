# Instructions pour GitHub Copilot - BatExtract

## Description du projet

BatExtract est un extracteur automatisÃ© de donnÃ©es de distribution d'espÃ¨ces de chauves-souris depuis les cartes officielles du Plan National d'Actions ChiroptÃ¨res franÃ§ais. Le projet utilise l'analyse de couleurs plutÃ´t que l'OCR pour extraire les donnÃ©es de distribution par dÃ©partement.

## Architecture actuelle (mise Ã  jour 2025)

### Workflow automatisÃ© complet

Le projet s'articule autour d'un workflow entiÃ¨rement automatisÃ© :

```bash
pnpm workflow  # Commande principale - exÃ©cute tout automatiquement
```

**Ã‰tapes du workflow :**

1. ğŸ§¬ **GÃ©nÃ©ration des donnÃ©es d'espÃ¨ces** â†’ Scraping dynamique du site officiel
2. ğŸ” **DÃ©couverte des URLs** â†’ Extraction des vraies URLs d'images
3. ğŸ“¥ **TÃ©lÃ©chargement** â†’ RÃ©cupÃ©ration des cartes de distribution
4. ğŸ¨ **Extraction** â†’ Analyse des couleurs par dÃ©partement
5. ğŸ“Š **Rapport Excel** â†’ Matrice finale espÃ¨ces Ã— dÃ©partements

### Scripts individuels

| Script                  | Fichier                      | Description                                    |
| ----------------------- | ---------------------------- | ---------------------------------------------- |
| `pnpm generate-species` | `src/generateSpeciesData.ts` | Scrape la liste des espÃ¨ces depuis le site web |
| `pnpm discover-urls`    | `src/discoverImageUrls.ts`   | DÃ©couvre les URLs rÃ©elles des images           |
| `pnpm download`         | `src/downloadMaps.ts`        | TÃ©lÃ©charge les cartes de distribution          |
| `pnpm extract`          | `src/extractSpeciesData.ts`  | Extrait les donnÃ©es par analyse de couleurs    |
| `pnpm excel`            | `src/generateExcelReport.ts` | GÃ©nÃ¨re le rapport Excel final                  |
| `pnpm workflow`         | `src/runCompleteWorkflow.ts` | Orchestrateur du workflow complet              |

### Structure des dossiers

```
src/                              # Code source
â”œâ”€â”€ extractSpeciesData.ts         # Point d'entrÃ©e extraction (remplace index.ts)
â”œâ”€â”€ generateSpeciesData.ts        # GÃ©nÃ©ration dynamique des espÃ¨ces
â”œâ”€â”€ discoverImageUrls.ts          # DÃ©couverte des URLs
â”œâ”€â”€ downloadMaps.ts               # TÃ©lÃ©chargement des cartes
â”œâ”€â”€ generateExcelReport.ts        # GÃ©nÃ©ration rapport Excel
â”œâ”€â”€ runCompleteWorkflow.ts        # Orchestrateur complet
â”œâ”€â”€ multiSpeciesExtractor.ts      # Logique d'extraction multi-espÃ¨ces
â”œâ”€â”€ smartExtractor.ts             # Analyse de couleurs par dÃ©partement
â””â”€â”€ types.ts                      # DÃ©finitions TypeScript

data/                             # Configuration statique uniquement
â””â”€â”€ color-legend-mapping.ts       # Mapping couleurs â†’ statuts

output/                           # Tous les fichiers gÃ©nÃ©rÃ©s (gitignored)
â”œâ”€â”€ generated-species-data.json   # Liste d'espÃ¨ces scrapÃ©e
â”œâ”€â”€ discovered-image-urls.json    # URLs dÃ©couvertes
â”œâ”€â”€ *-distribution.json           # DonnÃ©es par espÃ¨ce
â”œâ”€â”€ consolidated-species-report.json # Rapport consolidÃ©
â””â”€â”€ bat-distribution-matrix.xlsx  # Matrice Excel finale

images/                           # Cartes tÃ©lÃ©chargÃ©es (gitignored)
```

## Principes d'architecture

### 1. DonnÃ©es dynamiques vs statiques

- âœ… **Dynamique** : Liste des espÃ¨ces scrapÃ©e depuis le site officiel
- âœ… **Statique** : Configuration des couleurs (mapping RGB â†’ statuts)
- âœ… **SÃ©paration claire** : `data/` pour la config, `output/` pour le gÃ©nÃ©rÃ©

### 2. Consistance des noms de scripts

- âœ… **Pattern uniforme** : `{action}SpeciesData.ts` ou `{action}{Object}.ts`
- âœ… **CohÃ©rence** : Tous les scripts suivent la mÃªme convention de nommage
- âœ… **ClartÃ©** : Le nom du fichier reflÃ¨te exactement sa fonction

### 3. Gestion des outputs

- âœ… **CentralisÃ©** : Tous les fichiers gÃ©nÃ©rÃ©s dans `output/`
- âœ… **Git-friendly** : Dossier `output/` entiÃ¨rement dans `.gitignore`
- âœ… **Reproductible** : GÃ©nÃ©ration complÃ¨te possible depuis les sources

## Contexte technique

### Technologies utilisÃ©es

- **TypeScript** : Langage principal
- **Node.js + pnpm** : Runtime et gestionnaire de paquets
- **Sharp** : Traitement d'images et analyse de couleurs
- **ExcelJS** : GÃ©nÃ©ration de rapports Excel avec formatage
- **node-fetch** : Scraping web pour URLs et donnÃ©es d'espÃ¨ces

### Approche d'extraction

- **Analyse de couleurs** (pas d'OCR) : Plus robuste et prÃ©cis
- **CoordonnÃ©es prÃ©-mappÃ©es** : Chaque dÃ©partement a des coordonnÃ©es relatives fixes
- **Ã‰chantillonnage intelligent** : Analyse dans un rayon de 30px par dÃ©partement
- **TolÃ©rance RGB** : Gestion des variations de compression d'images

### Source des donnÃ©es

- **Site officiel** : https://plan-actions-chiropteres.fr
- **Scraping respectueux** : DÃ©lais entre requÃªtes, gestion d'erreurs
- **Fallbacks** : URLs de secours si dÃ©couverte Ã©choue

## Instructions spÃ©cifiques pour Copilot

### Quand modifier le code

1. **Ajout d'espÃ¨ces** : Ne pas modifier de fichiers statiques, le scraping s'en charge
2. **Nouveaux statuts de couleur** : Modifier `data/color-legend-mapping.ts`
3. **Nouveaux scripts** : Suivre le pattern `{action}SpeciesData.ts` et ajouter dans `package.json`
4. **Modifications d'output** : Toujours Ã©crire dans `output/`, jamais dans `data/`

### Conventions de code

1. **Noms de fichiers** : camelCase avec suffixe descriptif (`generateSpeciesData.ts`)
2. **Scripts npm** : kebab-case (`generate-species`, `discover-urls`)
3. **Messages de log** : Ã‰mojis pour catÃ©goriser (ğŸ§¬ gÃ©nÃ©ration, ğŸ” dÃ©couverte, ğŸ“¥ tÃ©lÃ©chargement, ğŸ¨ extraction, ğŸ“Š rapport)
4. **Chemins de fichiers** : Toujours absolus avec `path.join(process.cwd(), ...)`

### Points d'attention

1. **Migration des donnÃ©es** : Les fichiers gÃ©nÃ©rÃ©s sont maintenant dans `output/`, pas `data/`
2. **Scripts cohÃ©rents** : `src/extractSpeciesData.ts` remplace `src/index.ts`
3. **Workflow first** : Recommander `pnpm workflow` plutÃ´t que les scripts individuels
4. **Gestion d'erreurs** : Le workflow continue mÃªme si une Ã©tape Ã©choue partiellement

### Tests et validation

1. **Workflow complet** : Toujours tester `pnpm workflow` aprÃ¨s modifications importantes
2. **Scripts individuels** : Tester chaque script sÃ©parÃ©ment pour debugging
3. **Linting** : Utiliser `pnpm lint:fix` pour maintenir la qualitÃ© du code
4. **Validation outputs** : VÃ©rifier que les fichiers JSON et Excel sont bien gÃ©nÃ©rÃ©s

## Exemple de dÃ©veloppement

Pour ajouter une nouvelle fonctionnalitÃ© :

1. **CrÃ©er le script** : `src/newFeatureData.ts`
2. **Ajouter dans package.json** : `"new-feature": "ts-node src/newFeatureData.ts"`
3. **IntÃ©grer au workflow** : Ajouter l'Ã©tape dans `src/runCompleteWorkflow.ts`
4. **Tester** : `pnpm new-feature` puis `pnpm workflow`
5. **Documenter** : Mettre Ã  jour le README.md

Cette architecture garantit un projet maintenable, reproductible et extensible.
